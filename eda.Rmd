---
title: "EDA Ames Housing"
author: "Marcel Radwański"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
---

**Wczytanie bibliotek**

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(AmesHousing)
library(knitr)
library(kableExtra)
library(stringr) 

opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

**Ustawienie jednakowego motywu dla wykresów i definicja funkcji do tworzenia tabeli**

```{r}
theme_set(theme_light())

tabela <- function(df, ...){
  df %>%
    kable( align = "c", ...) %>%
    kable_styling(
      bootstrap_options = c("basic", "bordered", "condensed"),
      full_width = TRUE,
      position = "center"
    ) %>%
    row_spec(0, bold = TRUE, color = "black", background = "slategray")
}
```

**Wczytanie i wstępne przetworzenie danych**

```{r}
m2 <- 0.092903

data <- make_ames() %>%
  select(
    sale_price = Sale_Price,
    ground_living_area = Gr_Liv_Area,
    basement_area = Total_Bsmt_SF,
    lot_area = Lot_Area,
    garage_area = Garage_Area,
    quality_overall = Overall_Qual,
    condition_overall = Overall_Cond,
    year_built = Year_Built,
    year_remod = Year_Remod_Add,
    neighborhood = Neighborhood,
    building_type = Bldg_Type,
    full_baths = Full_Bath,
    month_sold = Mo_Sold,
    sale_condition = Sale_Condition
  ) %>%
  mutate(
    total_living_area = ground_living_area + basement_area,
    ground_living_area = round(ground_living_area * m2, 2),
    basement_area = round(basement_area * m2, 2),
    total_living_area  = round(total_living_area * m2, 2),
    lot_area = round(lot_area * m2, 2),
    garage_area = round(garage_area * m2, 2)
  ) %>%
  select(
    cena_sprzedazy = sale_price,
    pow_mieszkalna_naziemna = ground_living_area,
    pow_piwnicy = basement_area,
    pow_calkowita = total_living_area,
    pow_dzialki = lot_area,
    pow_garazu = garage_area,
    jakosc_ogolna = quality_overall,
    stan_ogolny = condition_overall,
    rok_budowy = year_built,
    rok_modernizacji = year_remod,
    miesiac_sprzedazy = month_sold,
    dzielnica = neighborhood,
    typ_zabudowy = building_type,
    warunki_sprzedazy = sale_condition,
    pelne_lazienki = full_baths
  )
```

**Zmiana wartości w kolumnach na język polski**

```{r}
data <- data %>%
  mutate(
    jakosc_ogolna = fct_recode(jakosc_ogolna,
      "Bardzo słaba" = "Very_Poor",
      "Słaba" = "Poor",
      "Dostateczna" = "Fair",
      "Poniżej średniej" = "Below_Average",
      "Średnia" = "Average",
      "Powyżej średniej" = "Above_Average",
      "Dobra" = "Good",
      "Bardzo dobra" = "Very_Good",
      "Doskonała" = "Excellent",
      "Wybitna" = "Very_Excellent"
    ),
    stan_ogolny = fct_recode(stan_ogolny,
        "Bardzo słaba" = "Very_Poor",
      "Słaba" = "Poor",
      "Dostateczna" = "Fair",
      "Poniżej średniej" = "Below_Average",
      "Średnia" = "Average",
      "Powyżej średniej" = "Above_Average",
      "Dobra" = "Good",
      "Bardzo dobra" = "Very_Good",
      "Doskonała" = "Excellent",
      "Wybitna" = "Very_Excellent"                     
    ),
    warunki_sprzedazy = fct_recode(warunki_sprzedazy,
      "Normalna" = "Normal",
      "Częściowa" = "Partial",
      "Rodzinna" = "Family",
      "Nietypowa" = "Abnorml",
      "Alokacja" = "Alloca",
      "Grunt przyległy" = "AdjLand"
    ),
    dzielnica = str_replace_all(dzielnica, "_", " "),
    typ_zabudowy = case_match(typ_zabudowy,
      "OneFam" ~ "Jednorodzinna",
      "TwoFmCon" ~ "Dwurodzinna",
      "Duplex" ~ "Bliźniak",
      "Twnhs" ~ "Szeregowa", 
      "TwnhsE"   ~ "Szeregowa",
    )
  )
```

# Opis danych

Zbiór danych AmesHousing zawiera informacje o transakcjach sprzedaży nieruchomości w mieście Ames w stanie Iowa.\
Zawiera on 81 kolumn, z których wybrane zostały:

1.  **cena_sprzedazy**: Cena sprzedaży nieruchomości wyrażona w dolarach amerykańskich

2.  **pow_mieszkalna_naziemna**: Powierzchnia mieszkalna domu nad ziemią (z wyłączeniem piwnicy) w m^2^.

3.  **pow_piwnicy**: Całkowita powierzchnia piwnicy w m^2^.

4.  **pow_calkowita** (zmienna utworzona): Suma powierzchni naziemnej oraz powierzchni piwnicy.

5.  **pow_dzialki**: Całkowita powierzchnia działki w m^2^.

6.  **pow_garazu**: Powierzchnia garażu w m^2^.

7.  **jakosc_ogolna**: Ogólna ocena materiałów i jakości wykończenia domu.

8.  **stan_ogolny**: Ogólna ocena stanu technicznego i konserwacji budynku.

9.  **rok_budowy**: Rok budowy nieruchomości.

10. **rok_modernizacji**: Rok ostatniego remontu lub modernizacji. Jeśli nie było remontu, data jest rokiem budowy.

11. **miesiac_sprzedazy**: Miesiąc, w którym dokonano transakcji.

12. **dzielnica**: Dzielnica miasta Ames.

13. **typ_zabudowy**: Typ budynku (np. dom jednorodzinny, bliźniak, zabudowa szeregowa).

14. **warunki_sprzedazy**: Warunki zawarcia transakcji (np. Normalna – standardowa sprzedaż rynkowa, Częściowa - sprzedaż nieukończonej nieruchomości, Nietypowa – sprzedaż wymuszona, Rodzinna – sprzedaż między członkami rodziny).

15. **pelne_lazienki**: Liczba pełnych łazienek w domu.

# Wstępne obserwacje

```{r}
data %>%
  psych::describe() %>%
  as_tibble(rownames = "Zmienna") %>%
  select(Zmienna, n, mean, sd, median, min, max, skew, kurtosis) %>%
  tabela(
    digits = 2,
    col.names = c("Zmienna", "N", "Średnia", "Odch. Std", "Mediana", "Min", "Max", "Skośność", "Kurtoza")
  )
```

1.  **cena_sprzedazy**: Dane wskazują na ogromną rozpiętość cenową rynku, średnia jest wyraźnie większa od mediany, co sugeruje obecność drogich nieruchomości zawyżających średnią rynkową. Zmienna ma wyraźną asymetrią prawostronną, wysoka kurtoza wskazuje na koncentrację wartości wokół średniej oraz występowanie wartości skrajnych.

2.  **pow_mieszkalna_naziemna**: Rozkład powierzchni mieszkalnej nad ziemią wykazuje dodatnią skośność. Wartości średniej i mediany są do siebie zbliżone, jednak maksymalna wartość jest prawie czterokrotnością średniej, co może wskazywać na pojedyncze rezydencje o bardzo dużej powierzchni.

3.  **pow_piwnicy**: Interpretacja zmiennej jest utrudniona, ze względu na fakt, że minimalna wartość = 0, oznaczająca brak piwnicy, występuje w zbiorze na tyle często, że może znacząco zaniżać średnią arytmetyczną.

4.  **pow_calkowita**: Zmienna daje realny obraz całkowitej przestrzeni, jaką dysponuje nabywca. Bardzo wysoka kurtoza pokazuje, że rozkład jest leptokurtyczny. Większość domów ma bardzo zbliżony, standardowy metraż, ale istnieją nieruchomości o bardzo dużej powierzchni (dodatnia skośność).

5.  **pow_dzialki**: Rozkład zmiennej wskazuje na duże zróżnicowanie: zdecydowana większość działek w Ames to standardowe ogródki przydomowe (mediana ok. 877m^2^), natomiast wartości statystyk są mocno zaburzone przez nieruchomości położone na działkach o ogromnej powierzchni.

6.  **pow_garazu**: Podobnie jak w przypadku piwnic, wartości statystyk są zaniżone przez nieruchomości bez garażu.

7.  **rok_budowy**: Rozkład roku budowy wykazuje lekką skośność ujemną, co oznacza, że w zbiorze przeważają budynki nowsze nad bardzo starymi. Zakres danych obejmuje 138 lat (1872–2010), przy czym mediana (1973) wskazuje, że połowa sprzedanych nieruchomości została wybudowana w ciągu ok. 40 lat przed ostatnią transakcją.

8.  **rok_modernizacji**: Trzeba pamiętać o definicji zmiennej - jeśli dom nie był remontowany, wpisywana jest data budowy. Mediana roku remontu (1993) jest o 20 lat wyższa od mediany roku budowy (1973), pokazuje to, że znaczna część starszych budynków przeszła modernizację.

9.  **miesiac_sprzedazy**: Średnia oraz mediana wskazują na czerwiec jako szczyt aktywności rynkowej. Niska skośność sugeruje, że rozkład jest symetryczny. Ujemna kurtoza wskazuje, że szczyt ilości transakcji, nie jest skupiony w jednym miesiącu. Można przypuszczać że wysoka liczba transakcji występuje przez parę miesięcy w połowie roku, a ich liczba spada jesienią w podobny sposób w jaki wzrasta wiosną. Te przypuszczenia potwierdza poniższy wykres:

    ```{r, fig.width = 10, fig.align="center"}
    data %>%
      mutate(miesiac_sprzedazy = as.factor(miesiac_sprzedazy)) %>%
      ggplot(aes(x = miesiac_sprzedazy)) +
      geom_bar(fill = "darkslateblue", color = "white") +
      labs(
        title = "Sezonowość transakcji",
        subtitle = "Liczba sprzedanych nieruchomości w poszczególnych miesiącach",
        x = "Miesiąc",
        y = "Liczba transakcji"
      ) + 
      theme(
        plot.title.position = "plot",
        plot.caption.position = "plot",
  
        plot.title = element_text(size = 20, face = "bold", color = "grey0", margin = margin(b = 10) ),
        plot.subtitle = element_text( size = 12, color = "grey40", margin = margin(b = 25) ),
  
        axis.title.x = element_text(size = 12, color = "grey15", margin = margin(t = 15)),
        axis.title.y = element_text(size = 12, color = "grey15", margin = margin(r = 15)),
        axis.text = element_text(size = 10, color = "grey50"),

        plot.margin = margin(t = 20, r = 20, b = 20, l = 20)
      )
    ```

10. **pelne_lazienki**: Średnia 1.57 przy medianie 2.00 sugeruje, że standardem są domy z 1-2 łazienkami, a nieruchomości z 3 lub 4 łazienkami są relatywnie rzadkie, ale występują.

# Analiza zmiennych kategorycznych

```{r}
data %>%
  count(jakosc_ogolna) %>%
  tabela(col.names = c("Ocena jakości wykończenia", "Liczba domów"))
```

Rozkład ocen jakości wykończenia jest asymetryczny, jest więcej nieruchomości o standardzie średnim i wyższym. Większość nieruchomości została oceniona lepiej niż "Średnia", mniej nieruchomości dostało bardzo niską ocenę. Na rynku w Ames znacznie częściej występują domy o podwyższonym standardzie niż budynki zaniedbane, które stanowią niewielką część wszystkich transakcji.

```{r}
data %>%
  count(stan_ogolny) %>%
  tabela(col.names = c("Ocena stanu technicznego", "Liczba domów"))
```

W przypadku ogólnego stanu technicznego widać, że ponad połowa obserwacji została oceniona jako średnia. W odróżnieniu od jakości wykończenia, tutaj znacznie rzadziej występują oceny wysokie. Prawdopodobnie wiele nieruchomości zostało wykonanych z jakościowych materiałów, ale zostały zaniedbane i nie są utrzymywane w dobrej kondycji.

```{r}
data %>% 
  count(typ_zabudowy, sort = TRUE) %>%
  tabela(col.names = c("Typ zabudowy", "Liczba domów"))
```

Struktura zabudowy w mieście Ames jest zdominowana przez wolnostojące domy jednorodzinne, które stanowią znaczącą większość wszystkich transakcji. Wyraźnie widać, że Ames jest niewielkim podmiejskim miastem: 9 pod względem ludności miasto w stanie Iowa, spośród tej populacji ok. połowa to studenci Iowa State University ( informacje z anglojęzycznego artykułu Wikipedii)

```{r}
data %>% 
  count(dzielnica, sort = TRUE) %>% 
  tabela(col.names = c("Dzielnica", "Liczba transakcji"))
```

Dane wskazują na bardzo silną koncentrację rynku w dzielnicy North Ames, w której zawarto najwięcej transakcji (443). Na końcu zestawienia znajduje się parę dzielnic o bardzo małej liczbie transakcji, co może sugerować, że są to obszary bardzo małe, ekskluzywne lub o niskiej płynności obrotu nieruchomościami.

Szczególnymi przypadkami są dzielnice Landmark i Green Hills, odnotowano w nich odpowiednio jedną i dwie transakcje, co uniemożliwia wyznaczenie wiarygodnych statystyk, dlatego powinny zostać wyłączone z dalszych analiz.

```{r}
data %>% 
  count(warunki_sprzedazy, sort = TRUE) %>%
  tabela(col.names = c("Warunki sprzedaży", "Liczba domów"))
```

Zdecydowana większość transakcji w zbiorze odbyła się na standardowych warunkach rynkowych. Obecność kategorii innych niż "Normalna" sugeruje, że niektóre ceny nieruchomości mogą znacząco być zniekształcone.

# Rozkład zmiennej objaśnianej - ceny

```{r, fig.width=9, fig.height=5, fig.align="center"}
data %>%
  ggplot(aes(x = cena_sprzedazy)) +
  geom_histogram(bins = 30, fill = "navy", color = "white") +
  scale_x_continuous(labels = scales::dollar_format()) +
  labs(
    title = "Struktura cen rynkowych",
    subtitle = "Rozkład cen sprzedaży nieruchomości w Ames",
    x = "Cena sprzedaży ($)",
    y = "Liczba domów"
  ) +
  theme(
    plot.title.position = "plot",
    plot.caption.position = "plot",
  
    plot.title = element_text(size = 20, face = "bold", color = "grey0", margin = margin(b = 10) ),
    plot.subtitle = element_text( size = 12, color = "grey40", margin = margin(b = 25) ),
  
    axis.title.x = element_text(size = 12, color = "grey15", margin = margin(t = 15)),
    axis.title.y = element_text(size = 12, color = "grey15", margin = margin(r = 15)),
    axis.text = element_text(size = 10, color = "grey50"),

    plot.margin = margin(t = 20, r = 20, b = 20, l = 20)
  )

data$cena_sprzedazy %>%
  summary() %>%
  as.list() %>%          
  as.data.frame() %>%
  tabela(
    digits = 0,          
    col.names = c("Min.", "1. Kwartyl", "Mediana", "Średnia", "3. Kwartyl", "Max.")
  )
```

Rozkład cen nieruchomości jest asymetryczny: w Ames dominują nieruchomości tanie i o umiarkowanej cenie.

Średnia (180 796 USD) jest wyraźnie wyższa od mediany (160 000 USD), co wskazuje, że grupa najdroższych nieruchomości zawyża średnią cenę rynkową.

Połowa wszystkich transakcji mieści się w przedziale od 129 500 USD do 213 500 USD.

Cena minimalna stanowi niecałe 10% wartości pierwszego kwartyla, co sugeruje, że może ona dotyczyć nieprzeciętnej transakcji, np. nieruchomości do rozbiórki lub sprzedaży między powiązanymi podmiotami.

Cena maksymalna stanowi ponad 350% wartości trzeciego kwartyla, może to oznaczać istnienie w zbiorze nieruchomości luksusowych i/lub o niezwykle dużej powierzchni.

# Analiza wartości skrajnych

```{r, fig.width=9, fig.height=7, fig.align="center"}
data %>%
  ggplot(aes(x = pow_mieszkalna_naziemna, y = cena_sprzedazy)) +
  geom_point(color = "saddlebrown", alpha = 0.5) +
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE, color = "black") +
  scale_y_continuous(labels = scales::dollar_format()) +
  labs(
    title = "Relacja ceny do powierzchni",
    subtitle = "Zależność ceny sprzedaży od powierzchni mieszkalnej nad ziemią",
    x = "Powierzchnia nad ziemią (m2)",
    y = "Cena sprzedaży"
  ) + 
  theme(
    plot.title.position = "plot",
    plot.caption.position = "plot",
  
    plot.title = element_text(size = 20, face = "bold", color = "grey0", margin = margin(b = 10) ),
    plot.subtitle = element_text( size = 12, color = "grey40", margin = margin(b = 25) ),
  
    axis.title.x = element_text(size = 12, color = "grey15", margin = margin(t = 15)),
    axis.title.y = element_text(size = 12, color = "grey15", margin = margin(r = 15)),
    axis.text = element_text(size = 10, color = "grey50"),

    plot.margin = margin(t = 20, r = 20, b = 20, l = 20)
  )
```

Wykres punktowy obrazuje silną, dodatnią zależność między mieszkalną powierzchnią nadziemną, a ceną sprzedaży. Oznacza to, że wielkość metrażu stanowi jeden z kluczowych czynników determinujących wartość nieruchomości — wraz ze wzrostem powierzchni rośnie również przeciętna cena rynkowa.

Widać również, że rozproszenie punktów względem linii trendu nie jest jednorodne - rozrzut obserwacji wokół linii trendu rośnie wraz ze wzrostem powierzchni nadziemnej: w przypadku mniejszych domów ceny są skupione, ale w przypadku dużych nieruchomości o cenie końcowej decydują inne czynniki (nie sam metraż).

Najważniejsze anomalie widać w dolnym prawym rogu wykresu: są to nieruchomości, które mimo bardzo dużego metrażu mają relatywnie niskie ceny. Odstają od rynkowego trendu, co może wskazywać na ich nietypowość. Obserwacje w górnym prawym rogu, czyli o wysokiej cenie i dużej powierzchni, mogą nie być anomaliami, a reprezentować nieruchomości luksusowe.

```{r, fig.width=10, fig.height=7, fig.align="center"}
data %>%
  ggplot(aes(x = pow_mieszkalna_naziemna, y = cena_sprzedazy)) +
  geom_point(color = "saddlebrown", alpha = 0.3, size = 1.2) +
  scale_y_continuous(labels = scales::dollar_format()) +
  facet_wrap(~warunki_sprzedazy) +
  labs(
    title = "Relacja ceny do powierzchni a typ transakcji",
    subtitle = "Zależność w podziale na warunki sprzedaży",
    x = "Powierzchnia mieszkalna nad ziemią (m2)",
    y = "Cena sprzedaży"
  )  +
  theme(
    strip.background = element_rect(fill = "gray90", color = "white"),
    strip.text = element_text(face = "bold", color = "black", size = 10),
    
    plot.title.position = "plot",
    plot.caption.position = "plot",
  
    plot.title = element_text(size = 20, face = "bold", color = "grey0", margin = margin(b = 10) ),
    plot.subtitle = element_text( size = 12, color = "grey40", margin = margin(b = 25) ),
  
    axis.title.x = element_text(size = 12, color = "grey15", margin = margin(t = 15)),
    axis.title.y = element_text(size = 12, color = "grey15", margin = margin(r = 15)),
    axis.text = element_text(size = 10, color = "grey50"),

    plot.margin = margin(t = 20, r = 20, b = 20, l = 20)
  )
```

Na powyższych wykresach widać, że domy o dużej powierzchni i niskiej cenie należą do transakcji dotyczących domów częściowo ukończonych - ich niska cena nie wynika z ceny rynkowej. Ze względu na ten nietypowy charakter należy usunąć ze zbioru odstające obserwacje.

```{r}
data %>%
  select(pow_mieszkalna_naziemna, cena_sprzedazy, warunki_sprzedazy) %>%
  arrange(desc(pow_mieszkalna_naziemna)) %>%
  head(7) %>%
  tabela(col.names = c("Powierzchnia", "Cena", "Warunki sprzedaży"))
```

Największą wartością powierzchni, która wydaje się nie zaburzać obserwacji, może być nieruchomość o powierzchni 354.89m^2^. Jest to zgodne z rekomendacją autora danych AmesHousing, który zaleca usunąć wszystkie wartości o powierzchni większej od ok. 370 m^2^.

```{r}
data %>%
  select(pow_mieszkalna_naziemna, cena_sprzedazy, warunki_sprzedazy) %>%
  arrange(cena_sprzedazy) %>%
  head(7) %>%
  tabela(col.names = c("Powierzchnia", "Cena", "Warunki sprzedaży"))
```

Jeśli chodzi o nieruchomości najtańsze - transakcje również są nietypowe, dlatego usuniemy transakcje dotyczące stosunkowo dużych nieruchomości po bardzo niskiej cenie, czyli tych o cenie niższej od 35 000 USD.

# Usunięcie nieruchomości zaburzających statystyki

Usuwamy ze zbioru obserwaje, które dotyczą:

1.  Nieruchomości o powierzchni powyżej 360 m^2^.

2.  Transakcje o cenie poniżej 35 000 USD.

3.  Dzielnic Landmark i Green Hills, zawierających za małą liczbę obserwacji.

```{r}
stats_before <- psych::describe(data$cena_sprzedazy) %>%
  as.data.frame() %>%
  mutate(Stan = "Przed czyszczeniem")

data <- data %>% 
  filter(pow_mieszkalna_naziemna < 360, cena_sprzedazy >= 35000, !dzielnica %in% c("Landmark", "Green Hills") )

stats_after <- psych::describe(data$cena_sprzedazy) %>%
  as.data.frame() %>%
  mutate(Stan = "Po czyszczeniu")

bind_rows(stats_before, stats_after) %>%
  select(Stan, n, mean, median, max, skew, kurtosis) %>%
  tabela(
    digits = 2, 
    caption = "Wpływ usunięcia wartości skrajnych na statystyki ceny",
    col.names = c("Stan", "N", "Średnia", "Mediana", "Max", "Skośność", "Kurtoza"),
    row.names = FALSE
  )
```

Porównanie statystyk przed i po usunięciu danych uzasadnia podjętą decyzję. Kurtoza znacznie spadła, więc w zbiorze już nie ma obserwacji, które rozciągały rozkład i zaburzały odchylenie standardowe. Mimo usunięcia największych nieruchomości, mediana nie zmieniła się, a średnia spadła nieznacznie.

# Czy lokalizacja istotnie wpływa na cenę?

Analiza wykresu zależności między powierzchnią a ceną pozwoliła na zauważenie faktu, że rozrzut obserwacji wokół linii trendu rośnie wraz ze wzrostem powierzchni nadziemnej, zatem o cenie końcowej decydują inne czynniki (nie sam metraż).

Sprawdźmy jak poziom cen różni się między dzielnicami.

```{r, fig.height=9, fig.width=10, fig.align="center"}
data %>%
  group_by(dzielnica) %>%
  summarise(mediana_ceny = median(cena_sprzedazy)) %>%
  ungroup() %>%
  mutate(dzielnica = fct_reorder(dzielnica, mediana_ceny)) %>%
  ggplot(aes(x = mediana_ceny, y = dzielnica)) +
  geom_segment(aes(x = 0, xend = mediana_ceny, y = dzielnica), 
               color = "grey80", linewidth = 0.8) +
  geom_point(color = "coral4", size = 4) +
  scale_x_continuous(
    labels = scales::dollar_format()
    ) +
  labs(
    title = "Hierarchia cenowa dzielnic",
    subtitle = "Mediana ceny sprzedaży w poszczególnych lokalizacjach",
    x = "Mediana ceny sprzedaży",
    y = NULL
  ) +
  theme(
    plot.title.position = "plot",
    plot.caption.position = "plot",
  
    plot.title = element_text(size = 20, face = "bold", color = "grey0", margin = margin(b = 10) ),
    plot.subtitle = element_text( size = 12, color = "grey40", margin = margin(b = 25) ),
  
    axis.title.x = element_text(size = 12, color = "grey15", margin = margin(t = 15)),
    axis.title.y = element_text(size = 12, color = "grey15", margin = margin(r = 15)),
    axis.text = element_text(size = 10, color = "grey50"),

    plot.margin = margin(t = 20, r = 20, b = 20, l = 20)
  )
```

Rozkład median cen w poszczególnych dzielnicach ujawnia podział rynku na cztery kategorie cenowe:

1.  Segment budżetowy: od Meadow Village do Mitchell, najliczniejsza grupa dzielnic, obejmująca zakres cenowy od poniżej 100 000 USD do trochę powyżej 150 000 USD. Najtańsza i jednocześnie jedyna dzielnica z medianą ceny poniżej 100 000 USD to Meadow Village. Wzrost cen między kolejnymi dzielnicami w tej grupie jest łagodny, jednak na końcu grupy następuje pierwszy wyraźny próg cenowy oddzielający ją od segmentu średniego.

2.  Segment średni: od Sawyer West do Crawford, grupa dzielnic obejmująca najwęższy zakres cen, od ok. 180 000 USD do 200 000 USD. Niewielkie różnice między dzielnicami sugerują, że jest to ustandaryzowany segment rynku o zbliżonym standardzie nieruchomości.

3.  Segment drogi: od Somerset do Veenker, mediany cen tych trzech dzielnic mieszczą się w przedziale 220 000 USD – 250 000 USD. Choć są wyraźnie droższe od średniej rynkowej, wciąż zachowują ciągłość cenową. Między najdroższą dzielnicą tego segmentu (Veenker), a kolejną grupą, występuje ogromna różnica w cenie.

4.  Segment premium: od Northridge do Stone Brooks, między tą a poprzednią grupą następuje największy skok cenowy na całym wykresie. Różnica mediany między Veenker, a Northridge wynosi ponad 50 000 USD. Wszystkie dzielnice w tej grupie przekraczają barierę 300 000 USD, co wyraźnie izoluje je od reszty miasta jako elitarne osiedla o zupełnie innym prestiżu.

# Jakie są różnice między nieruchomościami w poszczególnych segmentach?

**Przypisanie segmentu do każdej dzielnicy**

```{r}
budget_nbhd <- c("Meadow Village", "Briardale", "Iowa DOT and Rail Road", "Old Town",
                "Edwards", "Brookside", "Blueste", "Sawyer", "South and West of Iowa State University",
                "North Ames", "Northpark Villa", "Mitchell")

avg_nbhd <- c("Sawyer West", "Northwest Ames", "Gilbert", "Bloomington Heights",
              "Clear Creek", "Greens", "College Creek", "Crawford")

exp_nbhd <- c("Somerset", "Timberland", "Veenker")

premium_nbhd <- c("Northridge", "Northridge Heights", "Stone Brook")

data <- data %>%
  mutate(segment = case_when(
    dzielnica %in% budget_nbhd ~ "Budżetowy",
    dzielnica %in% avg_nbhd ~ "Średni",
    dzielnica %in% exp_nbhd ~ "Drogi",
    dzielnica %in% premium_nbhd ~ "Premium"
  )) %>%
  mutate(segment = factor(segment, levels = c("Budżetowy", "Średni", "Drogi", "Premium"))) %>%
  group_by(dzielnica) %>%
  mutate(mediana_ceny= median(cena_sprzedazy, na.rm = TRUE)) %>%
  ungroup()
```

## Czy poszczególne dzielnice znacząco różnią się strukturą zabudowy?

Rozwój miast w USA znacząco rożni się od rozwoju miast europejskich mających początki wieki temu. Ames, które powstało w 1869 roku, prawdopodobnie również jest przykładem rozwoju strefami, w których zabudowa jest jednorodna. Poniższa analiza zweryfikuje, czy w Ames ten schemat jest widoczny i czy najtańsze dzielnice to skupiska budżetowych domów szeregowych, które kontrastują z wolnostojącą zabudową w droższych strefach.

```{r, fig.height=12, fig.width=10, fig.align="center"}
data %>%
  mutate(dzielnica = fct_reorder(dzielnica, desc(mediana_ceny))) %>%
  count(segment, dzielnica, typ_zabudowy) %>%
  mutate(typ_zabudowy = str_wrap(typ_zabudowy, width = 10)) %>%
  ggplot(aes(x = typ_zabudowy, y = dzielnica, fill = n)) +
  geom_tile(color = "white", linewidth = 0.5) +
  geom_text(aes(label = n), color = "white", size = 3, fontface = "bold") +
  scale_fill_gradient(
    low = "skyblue",
    high = "midnightblue",
    trans = "log1p",
    breaks = c(1, 10, 50, 200, 400),
    name = "Liczba transakcji"
  ) +
  scale_x_discrete(position = "top") +
  facet_grid(segment ~ ., scales = "free_y", space = "free_y") +
  labs(
    title = "Struktura zabudowy w dzielnicach",
    subtitle = "Liczba transakcji w podziale na dzielnice i rodzaje budynków",
    x = NULL,
    y = NULL
  ) +
  theme(
    legend.position = "bottom",
    legend.key.width = unit(2, "cm"),
    panel.grid = element_blank(),
    strip.background = element_rect(fill = "gray90", color = "white"),
    strip.text = element_text(face = "bold", color = "black", size = 10),
    
    plot.title.position = "plot",
    plot.caption.position = "plot",
  
    plot.title = element_text(size = 20, face = "bold", color = "grey0", margin = margin(b = 10) ),
    plot.subtitle = element_text( size = 12, color = "grey40", margin = margin(b = 25) ),
  
    axis.title.x = element_text(size = 12, color = "grey15", margin = margin(t = 15)),
    axis.title.y = element_text(size = 12, color = "grey15", margin = margin(r = 15)),
    axis.text = element_text(size = 10, color = "grey50"),

    plot.margin = margin(t = 20, r = 20, b = 20, l = 20)
  )
```

*Z powodu bardzo dużych różnic między liczbą sprzedanych domów jednorodzinnych a innymi typami nieruchomości na wykresie zastosowałem skalę logarytmiczną*

W każdym segmencie cenowym domy jednorodzinne dominują na rynku nieruchomości w Ames. Są one zdecydowaną większością w dzielnicach takich jak North Ames (segment budżetowy), College Creek (segment średni), Somerset (segment drogi) czy Northridge Heights (segment premium). Wskazuje to na typowo podmiejski charakter miasta.

Zabudowa szeregowa, która zazwyczaj kojarzy się jako tańsza alternatywa dla domów wolnostojących, w Ames występuje w specyficzny sposób – jest popularna w najtańszych i najdroższych segmentach, a zanika w środku:

A. W segmencie budżetowym zabudowa szeregowa występuje w dzielnicach takich jak Meadow Village, Briardale, Northpark Villa czy Blueste, transakcje dotyczą wyłącznie tego typu nieruchomości. Pełnią tu one swoją tradycyjną funkcję – najtańszej opcji mieszkaniowej.

B. W segmencie średnim domy szeregowe stanowią mniejszość – kupujący wyraźnie preferują domy wolnostojące. Wyjątkiem jest Bloomington Heights, gdzie szeregówki dominują (oraz w mniejszym stopniu Greens). Sugeruje to, że w segmencie średnim nie są one rozproszone, ale tworzą dedykowane, zamknięte osiedla.

C. W segmencie drogim wyróżnia się dzielnica Somerset, gdzie szeregówki stanowią aż 1/3 wszystkich transakcji, współistniejąc z domami jednorodzinnymi.

D. W segmencie premium udział tego typu zabudowy jest zaskakująco wysoki, co przeczy stereotypowi taniego budownictwa. W dzielnicy Stone Brook stanowią one niemal połowę transakcji. Prawdopodobnie są to nowoczesne lokale, które oferują wysoki standard i prestiżową lokalizację dla zamożniejszych klientów, którzy nie chcą zajmować się utrzymaniem dużej działki.

## Czy segment premium oznacza budynki nowe, a segment budżetowy - stare?

Ten sam typ zabudowy występuje w Ames zarówno w tanich i drogich dzielnicach. Sugeruje to, że o przynależności do jakiegoś segmentu decydują inne czynniki. Sprawdzimy, czy takim czynnikiem jest wiek nieruchomości.

```{r, fig.height=10, fig.width=10, fig.align="center"}
data %>%
  mutate(dzielnica = fct_reorder(dzielnica, mediana_ceny)) %>%
  ggplot(aes(x = rok_budowy, y = dzielnica, fill = segment)) +
  geom_boxplot(alpha = 0.6, outlier.size = 0.5) +
  scale_fill_manual(values = c("Budżetowy" = "green3", "Średni" = "dodgerblue", "Drogi" = "purple3", "Premium" = "darkorange2")) +
  scale_x_continuous(breaks = seq(1880, 2010, by = 20)) +
  labs(
    title = "Wiek zabudowy a lokalizacja",
    subtitle = "Rozkład roku budowy w podziale na dzielnice",
    x = "Rok budowy",
    y = NULL,
    fill = "Segment cenowy"
  ) +
  theme(
    legend.position = "top",
    
    plot.title.position = "plot",
    plot.caption.position = "plot",
  
    plot.title = element_text(size = 20, face = "bold", color = "grey0", margin = margin(b = 10) ),
    plot.subtitle = element_text( size = 12, color = "grey40", margin = margin(b = 25) ),
  
    axis.title.x = element_text(size = 12, color = "grey15", margin = margin(t = 15)),
    axis.title.y = element_text(size = 12, color = "grey15", margin = margin(r = 15)),
    axis.text = element_text(size = 10, color = "grey50"),

    plot.margin = margin(t = 20, r = 20, b = 20, l = 20)
  )

data %>%
  mutate(dzielnica = fct_reorder(dzielnica, mediana_ceny)) %>%
  ggplot(aes(x = rok_budowy, y = dzielnica, color = segment)) +
  geom_jitter(alpha = 0.3, size = 2, height = 0.2) +
  scale_x_continuous(breaks = seq(1880, 2010, by = 20)) +
  scale_color_manual(values = c("Budżetowy" = "green3", "Średni" = "dodgerblue", "Drogi" = "purple3", "Premium" = "darkorange2")) +
  facet_wrap(~typ_zabudowy, ncol = 2) +
  labs(
    title = "Wiek zabudowy a typ budynku",
    subtitle = "Rozkład w podziale na typy budynków",
    x = "Rok budowy",
    y = NULL,
    color = "Segment cenowy"
  ) +
  theme(
    legend.position = "top",
    strip.background = element_rect(fill = "gray90", color = "white"),
    strip.text = element_text(face = "bold", color = "black", size = 10),
    
    plot.title.position = "plot",
    plot.caption.position = "plot",
  
    plot.title = element_text(size = 20, face = "bold", color = "grey0", margin = margin(b = 10) ),
    plot.subtitle = element_text( size = 12, color = "grey40", margin = margin(b = 25) ),
  
    axis.title.x = element_text(size = 12, color = "grey15", margin = margin(t = 15)),
    axis.title.y = element_text(size = 12, color = "grey15", margin = margin(r = 15)),
    axis.text = element_text(size = 10, color = "grey50"),

    plot.margin = margin(t = 20, r = 20, b = 20, l = 20)
  )
```

Rozkład lat budowy wewnątrz poszczególnych segmentów ujawnia, że rynek nieruchomości w Ames jest silnie skorelowany z czasem powstania budynku, jednak ta reguła posiada wyjątki.

1.  Segment budżetowy

    A. Najstarsze dzielnice miasta (np. Old Town, Edwards), których mediana roku budowy przypada na lata 1920–1940, ale najstarsze nieruchomości powstały jeszcze w XIX wieku. Wysoka obecność domów dwurodzinnych i bliźniaków (szczególnie w Old Town) może wskazywać, że duże, historyczne domy zostały z czasem podzielone na mniejsze i tańsze lokale mieszkalne.

    B. Dzielnice o zabudowie szeregowej z lat 70. (Meadow Village, Briardale), które zostały wybudowane w bardzo wąskim przedziale czasowym (ok. 1970–1980). Stanowią jednorodną grupę nieruchomości, które oferują najniższą cenę.

    C. Obszary zdominowane przez domy wybudowane w okresie powojennym (lata 50.-70.), np. North Ames, stanowiące znaczą część taniego mieszkalnictwa jednorodzinnego.

2.  Segment średni

    A. Dzielnice z lat 90. (np. Gilbert, Sawyer West, w których dominuje zabudowa jednorodzinnej, gdzie wyższa wycena rynkowa wynika prawdopodobnie bezpośrednio z młodszego wieku budynków (o ok. 20-30 lat względem North Ames).

    B. Anomalią jest dzielnica Crawford, której rozkład wiekowy jest zbliżony do obszarów z segmentu budżetowego przy jednoczesnym braku nowych inwestycji. Mimo wieku nieruchomości utrzymują ceny segmentu średniego, co sugeruje ich lepszy stan techniczny, większy metraż lub inne zalety.

    C. Bloomington Heights stanowi przykład nowszego budownictwa szeregowego, które odróżnia się od starszych odpowiedników z lat 70.

3.  Segment drogi

    A. Dzielnica Somerset, w której znajdują się niemal wyłącznie nieruchomości wybudowane w XXI wieku. Znaczący udział w strukturze dzielnicy mają nowoczesne domy szeregowe.

    B. Veenker to obszar domów jednorodzinnych z lat 70. i 80., który mimo dawnego roku budowy, utrzymuje wysoką wartość rynkową, co sugeruje istnienie innych cech podnoszących wartość tych nieruchomości.

4.  Segment premium

    A. Northridge Heights i Stone Brook to najnowsze dzielnice w zestawieniu, co potwierdza, że w najwyższym przedziale cenowym najważnieszą determinantą wartości jest nowoczesność. W Stone Brook luksusowe szeregówki stanowią znaczącą część oferty.

    B. Wyjątkiem jest dzielnica Northridge, która mimo starszej zabudowy (lata 90.) niż tańsze Somerset, ma ceny nieruchomości umieszczające ją w najdroższym segmencie. Wskazuje to, że w przypadku najbardziej ekskluzywnych nieruchomości wiek schodzi na drugi plan, a o cenie decyduje m.in. prestiż osiedla oraz metraż rezydencji.

Z wykresów można też odtworzyć historię rozwoju miasta: od gęstej zabudowy dzielnic takich jak Old Town, przez powojenny rozwój ówczesnych przedmieść, masową budowę szeregówek o niskim standardzie w latach 70, aż po budowę nowych ekskluzywnych osiedli nowoczesnych domów szeregowych i rezydencji.

## Jak nieruchomości różnią się metrażem w poszczególnych dzielnicach?

Warto sprawdzić, czy hierarchia cenowa dzielnic pokrywa się z hierarchią wielkości oferowanych tam domów. Intuicyjnie więcej płacąc powinniśmy dostawać w zamian większą nieruchomość.

```{r, fig.height=8, fig.width=10, fig.align="center"}
data %>%
  mutate(dzielnica = fct_reorder(dzielnica, mediana_ceny)) %>%
  ggplot(aes(x = pow_mieszkalna_naziemna, y = dzielnica, fill = segment)) +
  geom_boxplot(alpha = 0.6, outlier.size = 0.5) +
  scale_fill_manual(values = c("Budżetowy" = "green3", "Średni" = "dodgerblue", "Drogi" = "purple3", "Premium" = "darkorange2")) +
  scale_x_continuous(breaks = seq(50, 350, by = 50)) +
  labs(
    title = "Zróżnicowanie metrażu nieruchomości",
    subtitle = "Rozkład powierzchni mieszkalnej w podziale na dzielnice i segmenty cenowe",
    x = "Powierzchnia mieszkalna nadziemna (m2)",
    y = NULL,
    fill = "Segment cenowy"
  ) +
  theme(
    legend.position = "top",
    
    plot.title.position = "plot",
    plot.caption.position = "plot",
  
    plot.title = element_text(size = 20, face = "bold", color = "grey0", margin = margin(b = 10) ),
    plot.subtitle = element_text( size = 12, color = "grey40", margin = margin(b = 25) ),
  
    axis.title.x = element_text(size = 12, color = "grey15", margin = margin(t = 15)),
    axis.title.y = element_text(size = 12, color = "grey15", margin = margin(r = 15)),
    axis.text = element_text(size = 10, color = "grey50"),

    plot.margin = margin(t = 20, r = 20, b = 20, l = 20)
  )
```

Wykres pokazuje, że kolejność dzielnic pod względem ceny, nie pokrywa się idealnie z kolejnością pod względem wielkości naziemnej nieruchomości.

1.  W segmencie budżetowym znajdują się nieruchomości o bardzo zróżnicowanej powierzchni:

    A. Dzielnica Meadow Village ma najniższą medianę powierzchni w całym mieście oraz niską zmienność. Potwierdza to jej charakter jako osiedla taniej zabudowy szeregowej o powtarzalnym standardzie.

    B. Dzielnice takie jak Old Town czy Edwards prezentują parametry zbliżone do wyższych segmentów. Mediana metrażu jest tu wyraźnie wyższa, a górne wartości skrajne przekraczają 200 m^2^. Niska wycena tych nieruchomości nie wynika zatem z braku przestrzeni, lecz prawdopodobnie z ich wieku i stanu technicznego.

2.  W segmencie średnim w większości dzielnic (np. Gilbert, Sawyer West, Northwest Ames) nieruchomości są do siebie zbliżone metrażem. Mediana powierzchni w tych dzielnicach znajduje się w przedziale 140 - 160 m^2^, co może sugerować standard rynkowy.

    A. Widać dlaczego dzielnica Crawford, mimo wieku budynków, znajduje się w segmencie średnim, a nie budżetowym - dzielnica wyróżnia się wyższą medianą powierzchni. Występuje tu też bardzo duży rozrzut wartości, niektóre nieruchomości mają bardzo dużą powierzchnię, ale wiek budynku obniża ich cenę.

    B. Dzielnica Greens, która składa się z domów szeregowych wybudowanych w bardzo wąskim zakresie czasu, które mają bardzo podobną powierzchnię.

3.  W segmencie drogim budynki nie mają znacznie większego metrażem od segmentu średniego: metraż nie jest tu najważniejszym wyznacznikiem ceny - jest nim tu wiek budynku

    A. W Somerset i Timberland rozkłady powierzchni nie różnią się znacznie od tych w segmencie średnim, jest to dowód na to, że nabywcy są skłonni zapłacić więcej za nowsze budynki.

    B. W Veenker występują domy większe od tych w dwóch pozostałych dzielnicach tego segmentu, ale ich wiek sprawia, że przynależą do tego segmentu, a nie segmentu premium.

4.  W segmencie premium występuje wyraźny skok w metrażu, ale struktura dzielnic wykazuje pewne różnice:

    A. Dzielnica Northridge zdecydowanie dominuje pod względem wielkości nieruchomości. Jej mediana powierzchni jest wyraźnie przesunięta w prawo względem reszty stawki, a dolny kwartyl zaczyna się tam, gdzie kończą się mediany niższych segmentów. Oznacza to, że jest to obszar najbardziej elitarny pod względem przestrzeni – standardem są tu wielkie rezydencje.

    B. Dzielnice Northridge Heights i Stone Brook prezentują bardzo podobny rozkład powierzchni. Obie cechują się szerokim zakresem dostępnych metraży, co wyjaśnia fakt, że znajdują się tu zarówno domy szeregowe jak i domy jednorodzinne.

## Czy garaż jest standardem w każdym segmencie?

W realiach przedmieść amerykańskich, gdzie brakuje chodników, sieżek rowerowych oraz środków komunikacji zbiorowej, posiadanie samochodu jest konieczne do codziennego funkcjonowania. W rezultacie garaż jest ważnym elementem każdej nieruchomości. Sprawdzimy, czy ten wymóg przekłada się na standardy rynkowe w Ames.

```{r, fig.align="center"}
data %>%
  ggplot(aes(x = pow_garazu, y = segment, fill = segment)) +
  geom_boxplot(alpha = 0.6, outlier.size = 0.5) +
  scale_fill_manual(values = c("Budżetowy" = "green3", "Średni" = "dodgerblue", "Drogi" = "purple3", "Premium" = "darkorange2")) +
  scale_x_continuous(
    labels = scales::comma_format(suffix = " m2"), 
    breaks = seq(0, 200, by = 25) 
  ) +
  labs(
    title = "Powierzchnia garażu a segment cenowy",
    subtitle = "Rozkład powierzchni garażowej w podziale na grupy cenowe",
    x = "Powierzchnia garażu",
    y = NULL,
    fill = "Segment cenowy"
  ) +
  theme(
    legend.position = "none",
    
    plot.title.position = "plot",
    plot.caption.position = "plot",
  
    plot.title = element_text(size = 20, face = "bold", color = "grey0", margin = margin(b = 10) ),
    plot.subtitle = element_text( size = 12, color = "grey40", margin = margin(b = 25) ),
  
    axis.title.x = element_text(size = 12, color = "grey15", margin = margin(t = 15)),
    axis.title.y = element_text(size = 12, color = "grey15", margin = margin(r = 15)),
    axis.text = element_text(size = 10, color = "grey50"),

    plot.margin = margin(t = 20, r = 20, b = 20, l = 20)
  )
```

Analiza rozkładu powierzchni garażowej w podziale na segmenty cenowe ujawnia wyraźne różnice standardów rynkowych:

1.  Segment budżetowy to jedyna grupa, w której dolny wąs wykresu osiąga wartość 0 m^2^. Brak garażu jest w tym segmencie zjawiskiem rynkowo akceptowalnym i nie stanowi anomalii. Mediana wynosząca ok. 30–35 m² wskazuje, że dominującym standardem jest tu nieduży garaż mieszczący jeden samochód. Nieruchomości z większymi garażami stanowią w tej grupie margines.

2.  W segmencie średnim mediana wzrasta do ok. 45 m^2^, co odpowiada typowemu garażowi dwustanowiskowemu. Wąs dolny kończy się wyraźnie powyżej zera, w tej klasie cenowej garaż staje się obligatoryjny, a standard jednego stanowiska zmienia się na dwa stanowiska.

3.  W segmencie drogim rozkład jest wyraźnie przesunięty w prawą stronę względem segmentu średniego. Mediana wynosi powyżej 50 m^2^, a dolny kwartyl jest wyraźnie wyższy niż w segmencie średnim, nieruchomości bez garażu nie występują. Oznacza to, że w tym segmencie rzadziej spotyka się małe garaże dwustanowiskowe, a częściej przestronne garaże na dwa samochody z dodatkową powierzchnię gospodarczą.

4.  Segment premium wyróżnia się najwyższą medianą (ok. 70 m^2^) - standardem są garaże trzystanowiskowych. W segmencie premium praktycznie nie występują garaże mniejsze niż 40 m^2^.

# Analiza porównawcza zabudowy szeregowej

Wcześniejsza analiza struktury dzielnic ujawniła ciekawe zjawisko w występowaniu zabudowy szeregowej. Ten typ nieruchomości spodziewanie występuje licznie w najtańszych lokalizacjach, niemal zanika w segmencie średnim i nieoczekiwanie stanowi znaczącą część rynku drogich nieruchomości. Sprawdzimy, co różni szeregówkę z segmentu budżetowego od tej z segmentu premium i czy mamy tu do czynienia z tym samym produktem w innej lokalizacji, czy też z zupełnie odmienną klasą nieruchomości.

```{r}
szeregowe <- data %>%
  filter(typ_zabudowy == "Szeregowa")

szeregowe %>%
  group_by(segment) %>%
  summarise(
    Liczba_transakcji = n(),
    Srednia_cena = mean(cena_sprzedazy),
    Srednia_pow_calkowita = mean(pow_calkowita, na.rm = TRUE),
    Srednia_pow_dzialki = mean(pow_dzialki, na.rm = TRUE),
    Srednia_liczba_lazienek = mean(pelne_lazienki),
    Mediana_roku = median(rok_budowy)
  ) %>%
  tabela(
    digits = 0,
    caption = "Porównanie parametrów domów szeregowych w segmentach cenowych",
    col.names = c(
      "Segment",
      "Liczba transakcji",
      "Średnia cena",
      "Średnia powierzchnia całkowita", 
      "Średnia powierzchnia działki",
      "Średnia liczba łazienek",
      "Mediana roku budowy"
    )
  )
  
```

Tabela zestawiająca średnie parametry domów szeregowych w czterech segmentach cenowych pokazuje nieoczywiste relacje między ceną a oferowanym standardem:

1.  W segmencie budżetowym występuje najwięcej transakcji,charakteryzuje się on wyraźnie najniższym standardem: mała powierzchnia całkowita, niewielkie działki oraz obecność tylko jednej pełnej łazienki. Mediana roku budowy (1975) wskazuje, że są to osiedla z najstarszymi domami szeregowymi z zestawienia.

2.  W segmencie średnim i drogim następuje wyraźne podwyższenie standardu (standardem stają się 2 łazienki, a budynki są nowsze o blisko 30 lat). Porównanie tych dwóch grup ujawnia jednak anomalię: szeregówki w segmencie drogim mają mniejszy metraż i mniejsze działki. Mimo to osiągają wyższe ceny. Wskazuje to, że w tym segmencie o wartości decyduje prestiż lokalizacji, za który klienci są skłonni zapłacić więcej, rezygnując z części metrażu.

3.  W segmencie premium statystyki budynków są wyraźnie wyższe: w szczególności metraż działki. Są to również nieruchomości najnowsze (mediana 2005). Liczba łazienek pozostaje na poziomie 2, co sugeruje, że jest to standard wystarczający nawet dla luksusowej zabudowy szeregowej, a o wyższej cenie decyduje przede wszystkim przestrzeń i nowoczesność.

## Jaka jakość wykończenia dominuje w poszczególnych segmentach?

```{r, fig.height=9, fig.width=10, fig.align="center"}
szeregowe %>%
  mutate(jakosc_ogolna = fct_relevel(jakosc_ogolna, 
    "Bardzo słaba", "Słaba", "Dostateczna", "Poniżej średniej", 
    "Średnia", "Powyżej średniej", "Dobra", 
    "Bardzo dobra", "Doskonała", "Wybitna")) %>%
  ggplot(aes(x = jakosc_ogolna, fill = segment)) +
  geom_bar(color = "white", alpha = 0.6, show.legend = FALSE) + 
  scale_x_discrete(
    drop = FALSE, 
    labels = function(x) str_wrap(x, width = 10)
  ) + 
  scale_fill_manual(values = c("Budżetowy" = "green3", "Średni" = "dodgerblue", "Drogi" = "purple3", "Premium" = "darkorange2")) +
  facet_wrap(~segment, ncol = 1) +
  labs(
    title = "Rozkład jakości wykończenia w segmentach",
    subtitle = "Liczba domów szeregowych o danej jakości w podziale na segmenty cenowe",
    x = NULL,
    y = "Liczba domów"
  ) +
  theme(
    panel.grid.major.x = element_blank(),
    strip.background = element_rect(fill = "gray90", color = "white"),
    strip.text = element_text(face = "bold", color = "black", size = 10),
    
    plot.title.position = "plot",
    plot.caption.position = "plot",
  
    plot.title = element_text(size = 20, face = "bold", color = "grey0", margin = margin(b = 10) ),
    plot.subtitle = element_text( size = 12, color = "grey40", margin = margin(b = 25) ),
  
    axis.title.x = element_text(size = 12, color = "grey15", margin = margin(t = 15)),
    axis.title.y = element_text(size = 12, color = "grey15", margin = margin(r = 15)),
    axis.text = element_text(size = 10, color = "grey50"),

    plot.margin = margin(t = 20, r = 20, b = 20, l = 20)
  )
```

Analiza wykresu potwierdza istnienie wyraźnej zależności między segmentem cenowym a jakością wykończenia w zabudowie szeregowej. Dominanta rozkładu przesuwa się wyraźnie w kierunku wyższych ocen wraz ze wzrostem ceny nieruchomości:

1.  W segmencie budżetowym rozkład jest silnie skoncentrowany wokół jednej wartości – jakości "Średniej", która stanowi zdecydowaną większość obserwacji. Nieruchomości o standardzie "Dobra" lub wyższym stanowią w tej grupie margines, co sugeruje, że w najtańszych dzielnicach wyższy standard wykończenia występuje nieczęsto, rzadziej niż nieruchomości o jakości gorszej niż "Średnia.

2.  W segmencie średnim rozkład jest bardziej spłaszczony. Nie ma jednej, zdecydowanie dominującej kategorii. Największy udział w strukturze mają nieruchomości o jakości „Powyżej średniej”, ale ich liczba jest zbliżona to tych o jakości „Dobra” oraz "Bardzo dobra".

3.  W segmencie drogim dominantą staje się jakość „Dobra”, która stanowi najliczniejszą grupę obserwacji. W porównaniu do niższego segmentu, spada udział nieruchomości o jakości „Powyżej średniej” na rzecz tych ocenianych jako „Bardzo dobra” i wyższa. Struktura ta sugeruje, że w tej klasie cenowej standardem rynkowym jest wysoka jakość wykończenia, a nieruchomości o niższych parametrach stanowią mniejszość.

4.  W segmencie premium nie ma obserwacji poniżej jakości "Powyżej średniej". Dominują tu nieruchomości o standardzie "Bardzo dobra" i "Doskonała". Oznacza to, że wysoka jakość wykończenia jest standardem dla najdroższych lokalizacji, a nieruchomości o jakości przeciętnej w tym segmencie nie występują.

## Jak różnią się wielkości działek przynależnych do zabudowy szeregowej?

```{r, fig.height=10, fig.width=11, fig.align="center"}
szeregowe %>%
  filter(pow_dzialki > 0) %>%
  ggplot(aes(x = pow_dzialki, fill = segment)) +
  geom_density(alpha = 0.6, color = "white") +
  scale_fill_manual(values = c("Budżetowy" = "green3", "Średni" = "dodgerblue", "Drogi" = "purple3", "Premium" = "darkorange2")) +
  facet_wrap(~segment, ncol = 1) + 
  scale_x_continuous(labels = scales::comma_format(suffix = " m2"),
                     breaks = seq(0, 1500, by = 250)) +
  labs(
    title = "Powierzchnia działki a segment cenowy",
    subtitle = "Rozkład gęstości powierzchni gruntu w podziale na segmenty cenowe",
    x = "Powierzchnia działki",
    y = "Gęstość"
  ) +
  theme(
    legend.position = "none",
    axis.text.y = element_blank(),
    panel.grid.minor = element_blank(),
    strip.background = element_rect(fill = "gray90", color = "white"),
    strip.text = element_text(face = "bold", color = "black", size = 10),
    
    plot.title.position = "plot",
    plot.caption.position = "plot",
  
    plot.title = element_text(size = 20, face = "bold", color = "grey0", margin = margin(b = 10) ),
    plot.subtitle = element_text( size = 12, color = "grey40", margin = margin(b = 25) ),
  
    axis.title.x = element_text(size = 12, color = "grey15", margin = margin(t = 15)),
    axis.title.y = element_text(size = 12, color = "grey15", margin = margin(r = 15)),
    axis.text = element_text(size = 10, color = "grey50"),

    plot.margin = margin(t = 20, r = 20, b = 20, l = 20)
  )
```

Wykres gęstości powierzchni działek przy zabudowie szeregowej pokazuje ogromne różnice w strukturze gruntów przynależnych do nieruchomości w poszczególnych segmentach cenowych:

1.  W segmencie budżetowym rozkład jest najbardziej jednorodny, z wyraźną dominantą w wąskim przedziale 150–200 m^2^. Brak większych działek wskazuje na masowe budownictwo o sztywnym standardzie, co pokrywa się z faktem budowy osiedli w latach 70., gdzie grunt jest traktowany jako koszt niezbędny do postawienia budynku, a nie atut podnoszący jego wartość.

2.  Rozkład dla segmentu średniego jest znacznie szerszy. Jest tu istotna grupa nieruchomości z działkami w przedziale 300–400 m^2^. Oznacza to, że w tej klasie cenowej powierzchnia gruntu jest nadal ważnym czynnikiem wartości. W tym segmencie występują też nieruchomości o znacząco większych działkach.

3.  Rozkład w segmencie drogim jest przesunięty w lewo względem segmentu średniego. Wyższa cena nieruchomości nie wynika tu z wielkości gruntu. Zamożniejsi kupujący rezygnują z dużej działki na rzecz lepszego adresu i lepiej wykonanego domu.

4.  W segmencie premium rozkład jest najbardziej spłaszczony i rozciągnięty, co świadczy o braku standaryzacji. Występuje tu najwyższa wariancja powierzchni działek. Wskazuje to na indywidualny charakter każdej oferty w tym segmencie, gdzie wielkość gruntu nie podlega rynkowym schematom typowym dla tańszych osiedli.

## Co różni luksusowe szeregówki od luksusowych domów wolnostojących?

```{r, fig.height=7, fig.width=10, fig.align='center'}
data %>%
  filter(segment %in% c("Drogi", "Premium")) %>%
  filter(typ_zabudowy %in% c("Jednorodzinna", "Szeregowa")) %>% 
  ggplot(aes(x = pow_mieszkalna_naziemna, y = cena_sprzedazy, color = segment)) +
  geom_point(alpha = 0.5, size = 3) + 
  scale_color_manual(values = c("Drogi" = "purple3", "Premium" = "darkorange2")) +
  scale_y_continuous(labels = scales::dollar_format()) +
  facet_wrap(~typ_zabudowy) + 
  labs(
    title = "Relacja ceny do metrażu a typ zabudowy",
    subtitle = "Porównanie domów wolnostojących i szeregowych w segmentach Drogi i Premium",
    x = "Powierzchnia mieszkalna nadziemna (m2)",
    y = "Cena sprzedaży",
    color = "Segment cenowy",
  ) +
  theme(
    legend.position = "top",
    strip.background = element_rect(fill = "gray90", color = "white"),
    strip.text = element_text(face = "bold", color = "black", size = 10),
    
    plot.title.position = "plot",
    plot.caption.position = "plot",
  
    plot.title = element_text(size = 20, face = "bold", color = "grey0", margin = margin(b = 10) ),
    plot.subtitle = element_text( size = 12, color = "grey40", margin = margin(b = 25) ),
  
    axis.title.x = element_text(size = 12, color = "grey15", margin = margin(t = 15)),
    axis.title.y = element_text(size = 12, color = "grey15", margin = margin(r = 15)),
    axis.text = element_text(size = 10, color = "grey50"),

    plot.margin = margin(t = 20, r = 20, b = 20, l = 20)
  )
```

Na wykresie wyraźnie widać, że w najwyższych segmentach cenowych, domy szeregowe są pełnoprawnym substytutem domów wolnostojacych, nie odstając od większości z nich metrażem i ceną. Domy szeregowe nie tworzą oddzielnej, tańszej podgrupy, ale mieszają się z domami jednorodzinnymi. Jednak pomimo wysokiej pozycji rynkowej szeregówek, najwyższe ceny i największe metraże pozostają domeną rezydencji wolnostojących.

# Podsumowanie

1.  Rozkład cen w Ames jest wyraźnie asymetryczny (prawostronnie). Występuje wyraźna dodatnia korelacja między powierzchnią a ceną, ale ta relacja nie jest jednorodna w całym zbiorze. W przypadku największych rezydencji rozrzut cen rośnie, co sprawia, że trudno przewidzieć cenę wyłącznie na podstawie wielkości. Kluczową rolę odgrywają tu czynniki jakościowe, takie jak lokalizacja czy standard wykończenia.

2.  Analiza median cen pozwoliła na wyodrębnienie czterech segmentów rynkowych, które różnią się nie tylko ceną, ale i charakterystyką zabudowy:

    -   Segment Budżetowy: To głównie najstarsze domy (lata 20.–40.) oraz szeregówki z lat 70. Nieruchomości te mają najniższy standard wykończenia, a garaż jest tu rzadkością lub mieści tylko jedno auto.

    -   Segment Średni: Stanowi rynkowy standard, w którym dominują domy jednorodzinne (często z lat 90.) o powierzchni ok. 140–160 m^2^. Normą w tym segmencie jest garaż dwustanowiskowy oraz jakość wykończenia oceniana jako "Powyżej średniej".

    -   Segment Drogi: Obejmuje głównie nowoczesne budownictwo (po 2000 r.) oraz zadbane domy z lat 70./80. Mimo metrażu często zbliżonego do segmentu średniego, nieruchomości te osiągają wyższe ceny dzięki nowszemu budownictwu i wyższej jakości wykończenia.

    -   Segment Premium: Grupa najdroższych nieruchomości, wyraźnie oddzielona cenowo od reszty rynku. Wyróżnia się znacznym wzrostem powierzchni mieszkalnej, powszechnym standardem garaży trzystanowiskowych oraz najwyższymi ocenami jakości.

3.  Analiza domów szeregowych ujawniła, że ten typ zabudowy ma w Ames dwie główne funkcje:

    -   Ekonomiczną: Tanie, mniejsze szeregówki z lat 70. na małych działkach, stanowiące najtańsze nieruchomości na rynku.

    -   Luksusową: Nowoczesne lokale w segmencie premium, które oferują najwyższy standard wykończenia i stanowią istotną część oferty dla zamożnych klientów, konkurując ceną z domami wolnostojącymi.
